# ============================================================================
# Stage 1: Base with pnpm enabled
# ============================================================================
FROM node:22-slim AS base
WORKDIR /workspace/frontend
RUN corepack enable

# ============================================================================
# Stage 2: Dependencies - cached unless lock files change
# ============================================================================
FROM base AS deps

# Copy ONLY dependency-related files first (for optimal layer caching)
COPY frontend/package.json frontend/pnpm-lock.yaml frontend/pnpm-workspace.yaml ./
COPY frontend/apps/web/package.json ./apps/web/
COPY frontend/packages/api-client/package.json ./packages/api-client/
COPY frontend/packages/assistant-runtime/package.json ./packages/assistant-runtime/

# Install dependencies - this layer is cached unless package*.json or lock changes
RUN pnpm install --frozen-lockfile

# ============================================================================
# Stage 3: Development - uses preview with watch (no WebSocket HMR)
# ============================================================================
FROM deps AS development

# Copy config files (rarely change)
COPY frontend/vitest.config.ts frontend/eslint.config.js frontend/.prettierrc.json frontend/.prettierignore ./

# Copy source code (changes frequently - but compose watch handles sync)
COPY frontend/apps ./apps
COPY frontend/packages ./packages

WORKDIR /workspace/frontend/apps/web
# Use preview:watch - builds on .ts/.css changes, serves via vite preview (no WebSocket)
CMD ["pnpm", "preview:watch"]

# ============================================================================
# Stage 4: Production build
# ============================================================================
FROM deps AS build

# Copy config files
COPY frontend/vitest.config.ts frontend/eslint.config.js frontend/.prettierrc.json frontend/.prettierignore ./

# Copy source code
COPY frontend/apps ./apps
COPY frontend/packages ./packages

WORKDIR /workspace/frontend/apps/web
ENV VITE_API_BASE_URL=""
RUN pnpm build

# ============================================================================
# Stage 5: Production runtime - minimal image with built assets
# ============================================================================
FROM base AS production

# Copy only node_modules needed for preview server
COPY --from=deps /workspace/frontend/node_modules ./node_modules
COPY --from=deps /workspace/frontend/apps/web/node_modules ./apps/web/node_modules
COPY frontend/apps/web/package.json ./apps/web/

# Copy built assets
COPY --from=build /workspace/frontend/apps/web/dist ./apps/web/dist

WORKDIR /workspace/frontend/apps/web
CMD pnpm preview
